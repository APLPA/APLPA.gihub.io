

<!DOCTYPE html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
    <title>工作流引擎 — Vue.js</title>
    <meta charset="utf-8">
    <meta name="description" content="IJEP - The Intelligence Java Enterpise Develop Platform">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="alternate" hreflang="x-default" href="https://vuejs.org/v2/workflow/index.html">
    <link rel="alternate" hreflang="zh" href="https://cn.vuejs.org/v2/workflow/index.html">
    <link rel="alternate" hreflang="ja" href="https://jp.vuejs.org/v2/workflow/index.html">
    <link rel="alternate" hreflang="ru" href="https://ru.vuejs.org/v2/workflow/index.html">
    <link rel="alternate" hreflang="ko" href="https://kr.vuejs.org/v2/workflow/index.html">
    <link rel="alternate" hreflang="pt-BR" href="https://br.vuejs.org/v2/workflow/index.html">
    <link rel="alternate" hreflang="fr" href="https://fr.vuejs.org/v2/workflow/index.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="工作流引擎 — Vue.js">
    <meta property="og:description" content="IJEP - The Intelligence Java Enterpise Develop Platform">
    <meta property="og:image" content="https://aplpa.github.io//images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="工作流引擎 — Vue.js">
    <meta name="twitter:description" content="IJEP - The Intelligence Java Enterpise Develop Platform">
    <meta name="twitter:image" content="https://aplpa.github.io/images/logo.png">

    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
    <meta name="msapplication-TileImage" content="/images/icons/ms-icon-144x144.png">
    <link rel="icon" href="/images/logo.png" type="image/png">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">

    <!-- <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'> -->
    <!-- <link href='//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js' rel='stylesheet' type='text/css'> -->

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="/js/vue.js"></script>
    <script>
      Vue.config.productionTip = false
      window.PAGE_TYPE = "workflow"
    </script>

    <!-- ga -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46852172-3', 'aplpa.github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body class="docs">
    <div id="mobile-bar">
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div id="header">
  <a id="logo" href="/">
    <img src="/images/logo.png" alt="vue logo">
    <span>IJEP</span>
  </a>
  <ul id="nav">
    <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
</li>
<li>
  <a href="/v2/workflow/index.html" class="nav-link team">流程引擎</a>
  <a href="#" class="nav-link team" title="敬请期待">规则引擎</a>
  <a href="#" class="nav-link team" title="敬请期待">调度引擎</a>
</li>
<li><a href="http://47.75.157.75:9091/" target="_blank" class="nav-link contribute">官方网站</a></li>

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
</li>
<li>
  <a href="/v2/workflow/index.html" class="nav-link team">流程引擎</a>
  <a href="#" class="nav-link team" title="敬请期待">规则引擎</a>
  <a href="#" class="nav-link team" title="敬请期待">调度引擎</a>
</li>
<li><a href="http://47.75.157.75:9091/" target="_blank" class="nav-link contribute">官方网站</a></li>

    </ul>
    <div class="list">
      
        <h2>
          
          
        </h2>
        <ul class="menu-root">
  
    
    
    <li>
      <a href="/v2/workflow/index.html" class="sidebar-link current">工作流引擎</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>


<div class="content workflow with-sidebar ">
  
    

    
  
  
    <h1>工作流引擎</h1>
  


  
    <blockquote>
<p>作者：李涛</p>
<p>日期：2019年4月11日</p>
</blockquote>
<h2 id="1-快速入门"><a href="#1-快速入门" class="headerlink" title="1 快速入门"></a>1 快速入门</h2><p>看过流程引擎介绍的童鞋详细对工作流有一定的了解了，下面大家跟我来体验下怎么开发一个工作流。</p>
<h3 id="1-1-环境准备"><a href="#1-1-环境准备" class="headerlink" title="1.1 环境准备"></a>1.1 环境准备</h3><p>你需要确认你本地的开发环境已经有如下的基础环境。</p>
<ul>
<li>开发工具:IDEA/Eclipse</li>
<li>Java version 1.8</li>
<li>Maven 3.3.9</li>
<li>Mysql 5.7 （数据库可使用远程数据库cms）</li>
</ul>
<h3 id="1-2-需求分析"><a href="#1-2-需求分析" class="headerlink" title="1.2 需求分析"></a>1.2 需求分析</h3><p>这里我们有一份简单的需求：差旅费用报销流程——员工提交报销申请，报销金额在0-500由直属经理审批，报销金额超过500则还需要总经理审批。差旅费用的核心字段有：员工号、员工姓名、费用类型、费用金额、申请日期、费用状态等。</p>
<p>我们简单分析这个流程，这个流程涉及到三个角色：员工、经理、总经理。审批流程的节点数量跟金额有关，当金额在0-500时，需要经理审批，只有两个节点；当金额大于500时，需要经理加上总经理审批，总共3个节点。我们可以画出流程图:</p>
<p><img src=".\workflow-image\费用报销流程.png" alt="1555240037213"></p>
<p>OK，这个流程图一目了然。我们简单分析了需求，下面我们来设计表吧！</p>
<h3 id="1-3-数据库设计"><a href="#1-3-数据库设计" class="headerlink" title="1.3 数据库设计"></a>1.3 数据库设计</h3><p>表很简单就是一个差旅费用申请表 ers_travel_expense。字段就是需求中提到的字段：</p>
<table>
<thead>
<tr>
<th>字段编码</th>
<th>字段名称</th>
<th>字段类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>主键</td>
<td>varchar(64)</td>
<td>主键</td>
</tr>
<tr>
<td>emp_no</td>
<td>员工号</td>
<td>varchar(10)</td>
<td>员工号</td>
</tr>
<tr>
<td>emp_name</td>
<td>员工姓名</td>
<td>varchar(16)</td>
<td>员工姓名</td>
</tr>
<tr>
<td>charge_type</td>
<td>费用类型</td>
<td>tinyint</td>
<td>费用类型：1 出租车费 2 酒店费用</td>
</tr>
<tr>
<td>amount</td>
<td>金额</td>
<td>numeric(16,2)</td>
<td>金额</td>
</tr>
<tr>
<td>apply_date</td>
<td>申请日期</td>
<td>datetime</td>
<td>申请日期</td>
</tr>
<tr>
<td>status</td>
<td>审批状态</td>
<td>tinyint</td>
<td>审批状态：草稿、审批中、审批完成</td>
</tr>
</tbody>
</table>
<p>这样我们按基本的表设计规范来创建表即可, 注意添加IJep平台固定字段.</p>
<pre><code class="hljs mysql">CREATE TABLE `ers_travel_expense` (
	`id_` VARCHAR (64) NOT NULL COMMENT &apos;主键&apos;,
	`emp_no_` VARCHAR (10) NULL COMMENT &apos;员工号&apos;,
	`emp_name_` VARCHAR (16) NULL COMMENT &apos;员工姓名&apos;,
	`charge_type_` TINYINT (1) NULL COMMENT &apos;费用类型：0出租车、1酒店&apos;,
	`amount_` NUMERIC (16, 2) NULL COMMENT &apos;金额&apos;,
	`apply_date_` datetime NULL COMMENT &apos;申请日期&apos;,
	`status_` TINYINT (1) NULL COMMENT &apos;审批状态&apos;,
	`tenant_id_` VARCHAR (64) COMMENT &apos;租户&apos;,
	`created_by_id_` VARCHAR (64) COMMENT &apos;创建人id&apos;,
	`created_by_name_` VARCHAR (64) COMMENT &apos;创建人名称&apos;,
	`created_time_` datetime COMMENT &apos;创建时间&apos;,
	`delflag_` VARCHAR (1) COMMENT &apos;逻辑删除标记&apos;,
	`modified_by_id_` VARCHAR (64) COMMENT &apos;修改人id&apos;,
	`modified_by_name_` VARCHAR (64) COMMENT &apos;修改人名称&apos;,
	`modified_time_` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &apos;修改时间&apos;,
	`version_` INT (11) COMMENT &apos;版本&apos;,
	PRIMARY KEY (`id_`)
);</code></pre>
<h3 id="1-4-生成代码"><a href="#1-4-生成代码" class="headerlink" title="1.4 生成代码"></a>1.4 生成代码</h3><p>表设计完成后，利用我们的代码生成器生成对应的业务代码。目前这个代码生成器还不支持流程相关代码生成，不过后续会补充。</p>
<p><img src=".\workflow-image\生成代码.png" alt="1555243345110"></p>
<p>生成代码后，费用申请的功能就可以增删查改了，将生成的代码拷贝到项目（cms-service）中。</p>
<p><img src=".\workflow-image\代码预览.png" alt="1555243455757"></p>
<h3 id="1-5-绘制流程图"><a href="#1-5-绘制流程图" class="headerlink" title="1.5 绘制流程图"></a>1.5 绘制流程图</h3><p>代码生成好以后，现在我们需要绘制流程图了。绘制流程图，你可以使用IDEA的 activiti插件来画流程图，也可以使用ijep自带工作流引擎在线绘制流程图。如果使用Activiti插件来绘制流程图，可以查看<a href="https://blog.csdn.net/gozhuyinglong/article/details/80336765" target="_blank" rel="noopener">本教程</a>安装插件。我这里只介绍使用ijep自带工作流引擎绘制流程图。</p>
<p>你可以启动本地服务ijep-service-sys、ijep-service-bpm来绘制流程图也可以使用远程<a href="http://47.101.197.164:808的服务来绘制流程图。" target="_blank" rel="noopener">http://47.101.197.164:808的服务来绘制流程图。</a></p>
<p>访问菜单<code>工作流引擎</code>-<code>基础功能</code>-<code>流程模板管理</code>。</p>
<p><img src=".\workflow-image\流程引擎菜单-模版管理.png" alt="1555244542317"></p>
<p>在列表中随意选择一个流程模板，点击在线设计，然后在打开的流程图中，按Ctrl + A 全选，然后按del删除所有节点。（为什么要这样操作？因为这里有个bug…… Orz 囧）</p>
<p><img src=".\workflow-image\准备删除.png" alt="1555244689488"></p>
<p>删除所有节点后，是空白的，你可以全屏来编辑流程图，获得更好的操作体验。</p>
<p><img src=".\workflow-image\空白流程图.png" alt="1555244806275"></p>
<p>好了，我们现在需要把需求分析中绘制的流程图，绘制出来就OK了。注意下图所示，你设定连线（flow）上的条件表达式，很简单不是吗？</p>
<p><img src=".\workflow-image\金额表达式.png" alt="1555245001840"></p>
<p> <img src=".\workflow-image\金额大于等于500.png" alt="1555245092484"></p>
<p>哦，还有一点，我们需要配置好流程图id和name。在空白区域点击一下，出现流程的属性，设定流程id和name。</p>
<p><img src=".\workflow-image\修改流程id和name.png" alt="1555245251787"></p>
<p>最后，我们要把所有的Task都设置为UserTask（用户任务），如下图所示。</p>
<p><img src=".\workflow-image\修改任务类型.png" alt="1555245417680"></p>
<p>OK，调整完成后，你的流程图应该看起来像下面这样，然后点击保存按钮。</p>
<p><img src=".\workflow-image\最终流程图.png" alt="1555245490471"></p>
<h3 id="1-6-部署流程"><a href="#1-6-部署流程" class="headerlink" title="1.6 部署流程"></a>1.6 部署流程</h3><p>流程图保存成功后，让我们来部署流程。如果你绘制的过程中出现了很多问题，你可以点击卸载，把刚刚保存的流程图删掉。</p>
<p><img src=".\workflow-image\部署费用流程.png" alt="1555245672653"></p>
<h3 id="1-7-创建流程表单"><a href="#1-7-创建流程表单" class="headerlink" title="1.7 创建流程表单"></a>1.7 创建流程表单</h3><p>部署流程成功后，我们需要添加流程表单。添加表单非常简单，将流程使用到的业务表的字段添加进来即可。</p>
<p>首先我们创建业务表单，菜单<code>工作流引擎</code>-<code>基础功能</code>-<code>表单管理</code>。</p>
<p><img src=".\workflow-image\创建表单.png" alt="1555245867433"></p>
<p>点击新增表单，记得表单类型这里只能选择<strong>自定义表单</strong>，暂时不支持动态表单。</p>
<p><img src=".\workflow-image\自定义表单.png" alt="1555245983567"></p>
<p>下面来设计表单。选中刚刚创建的表单，点击设计按钮。</p>
<p><img src=".\workflow-image\设计表单按钮.png" alt="1555246032122"></p>
<p>在设计表单的时候，我们需要把业务表单的字段添加进来。这里的目的是让流程引擎知道你的业务数据，可以用在判断条件（condition）上。记得点击保存按钮，我经常忘记点击保存按钮……吃了亏。</p>
<p><img src=".\workflow-image\填写表单字段.png" alt="1555246299187"></p>
<p>填写完成后，启用表单即可。</p>
<h3 id="1-8-创建角色和设定权限"><a href="#1-8-创建角色和设定权限" class="headerlink" title="1.8 创建角色和设定权限"></a>1.8 创建角色和设定权限</h3><p>这一步可以提前到需求分析完成后进行。我们流程中涉及到三个角色，一般员工、经理、总经理。这里没有涉及到机构的概念，当然我们在做银行的业务的时候，一般会有总行、分行、支行三个层级，还有不同的部门。这里我们没有考虑总分支机构，默认这三个角色都是同一个机构层级——总行。一般员工不需要创建岗位，就是任意一个员工都可以，我们还需要创建经理、总经理岗位（角色类型）。</p>
<p><em>说到这里，我稍微解释下岗位（角色类型）和角色的关系。在ijep平台中，岗位是基础职责单位，角色就是某个机构层级上的岗位。例如角色叫总行管理岗，那么岗位就是管理岗。只有角色才能分配到人，岗位不能分配。这个岗位可以是真实的岗位，也可以是虚拟的岗位。你可以灵活设定，只要满足业务需求即可。</em></p>
<h4 id="1-8-1-创建岗位"><a href="#1-8-1-创建岗位" class="headerlink" title="1.8.1 创建岗位"></a>1.8.1 创建岗位</h4><p>首先创建两个岗位，在菜单系统管理-系统配置-角色类型 中创建两个角色类型。</p>
<p><img src=".\workflow-image\创建岗位.png" alt="1555247256071"></p>
<h4 id="1-8-2-创建角色"><a href="#1-8-2-创建角色" class="headerlink" title="1.8.2 创建角色"></a>1.8.2 创建角色</h4><p>然后创建角色。</p>
<p><img src=".\workflow-image\编辑角色.png" alt="1555247341241"></p>
<p><img src=".\workflow-image\创建角色完成.png" alt="1555247444279"></p>
<h4 id="1-8-3-授权菜单"><a href="#1-8-3-授权菜单" class="headerlink" title="1.8.3 授权菜单"></a>1.8.3 授权菜单</h4><p>角色创建后，你还需要为角色授权菜单。</p>
<p><img src=".\workflow-image\授权菜单.png" alt="1555251363285"></p>
<h4 id="1-8-4-赋予角色"><a href="#1-8-4-赋予角色" class="headerlink" title="1.8.4 赋予角色"></a>1.8.4 赋予角色</h4><p>最后，你还需要找两个顺眼的人员，为他们赋予相应的角色。</p>
<p><img src=".\workflow-image\赋予角色.png" alt="1555250941546"></p>
<h3 id="1-9-编辑业务流程"><a href="#1-9-编辑业务流程" class="headerlink" title="1.9 编辑业务流程"></a>1.9 编辑业务流程</h3><p>点击菜单 工作流引擎-基础功能-业务流程管理，访问到业务流程列表。在这里我们需要完成流程的细节配置。</p>
<p><img src=".\workflow-image\业务流程列表-创建.png" alt="1555247773905"></p>
<p>点击新增按钮，新增一个费用审批流程，选择我们之前创建好的流程模板、流程表单，记得服务名称填写正确，这个名称是你的微服务名称对应配置在<code>application-dev.yml</code> ,<code>sping.application.name=cms-service</code></p>
<p><img src=".\workflow-image\创建业务流程.png" alt="1555247689474"></p>
<p>完成创建以后，选中刚刚创建的费用审批流程，点击设计。为每个节点配置候选岗位，第一个usertask不用配置。</p>
<p><img src=".\workflow-image\节点配置角色.png" alt="1555248178720"></p>
<p>最后配置变量映射，将我们在模板定义的时候定义的变量，映射到表单字段上。</p>
<p><img src=".\workflow-image\变量映射.png" alt="1555248256691"></p>
<p>配置完成后，启用业务流程即可。</p>
<p><em>如果你不能正确启用，可能是变量映射不成功，可以谨慎修改表 wf_proc_var_map</em></p>
<h3 id="1-10-编写发起流程代码"><a href="#1-10-编写发起流程代码" class="headerlink" title="1.10 编写发起流程代码"></a>1.10 编写发起流程代码</h3><p>终于配置好了流程，我们来写代码吧。回到刚刚生成的代码，我们需要增加发起流程的接口，另外当流程审批完成后，我们需要更新费用审批状态为已审批。so，easy的东西，准备好了吗？开始吧。</p>
<pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/startProcess"</span>)
<span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"发起流程"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">startProcess</span><span class="hljs-params">(@RequestBody TravelExpense travelExpense)</span></span>&#123;
    TravelExpense travel = travelExpenseService.get(travelExpense.getId());
    travel.setApplyDate(<span class="hljs-keyword">new</span> Date());
    travel.setStatus(TravelExpenseStatus.APPROVING.getCode()); <span class="hljs-comment">//由草稿变更为审批中</span>
    travelExpenseService.update(travel);

    <span class="hljs-comment">//这一步可以直接由前台发起也可</span>
    JSONObject jsonObject = <span class="hljs-keyword">new</span> JSONObject();
    jsonObject.put(<span class="hljs-string">"procCode"</span>, TravelConstant.process_code); <span class="hljs-comment">//这个是业务流程的编码</span>
    jsonObject.put(<span class="hljs-string">"newData"</span>, JSON.toJSONString(travel));
    jsonObject.put(<span class="hljs-string">"oldData"</span>, <span class="hljs-keyword">null</span>);
    jsonObject.put(<span class="hljs-string">"procInstId"</span>, <span class="hljs-keyword">null</span>);
    workFlowClient.saveAndStart(jsonObject);
    <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"操作成功"</span>);
&#125;</code></pre>
<h3 id="1-11-创建ProcessFromHanlder"><a href="#1-11-创建ProcessFromHanlder" class="headerlink" title="1.11 创建ProcessFromHanlder"></a>1.11 创建ProcessFromHanlder</h3><p>这个是干什么的？这个地方是给前端查看流程数据时返回路由的。这个路径由前端提供。</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pactera.cms.travel.handler;

<span class="hljs-keyword">import</span> com.pactera.cms.travel.constant.TravelConstant;
<span class="hljs-keyword">import</span> com.pactera.jep.workflow.api.WorkflowException;
<span class="hljs-keyword">import</span> com.pactera.jep.workflow.client.ProcessFormHandler;
<span class="hljs-keyword">import</span> com.pactera.jep.workflow.client.annotation.FormHandler;

<span class="hljs-comment">/**
 * 处理业务数据
 *
 * <span class="hljs-doctag">@Author</span>: 李涛
 * <span class="hljs-doctag">@CreateDate</span>: 2019/4/14 21:53
 * <span class="hljs-doctag">@Version</span>: 1.0
 */</span>
<span class="hljs-meta">@FormHandler</span>(TravelConstant.process_code)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TravelFormHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProcessFormHandler</span></span>&#123;

    <span class="hljs-comment">/**
     * 处理业务数据
     * <span class="hljs-doctag">@param</span> nodeKey 流程节点
     * <span class="hljs-doctag">@param</span> data 表单数据
     * <span class="hljs-doctag">@param</span> opt  处理动作
     * <span class="hljs-doctag">@return</span>
     * <span class="hljs-doctag">@throws</span> WorkflowException
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">processForm</span><span class="hljs-params">(String nodeKey, String data, String opt)</span> <span class="hljs-keyword">throws</span> WorkflowException </span>&#123;
        <span class="hljs-comment">// nodeKey是节点id，判断不同的节点可以返回不同的前端路由</span>
        <span class="hljs-comment">// data 是流程数据，你可以在这里处理流程相关数据</span>
        <span class="hljs-comment">// opt 这个是处理动作，可以知道是审批通过还是拒绝</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"travelExpense/travelExpenseView"</span>;
    &#125;
&#125;</code></pre>
<h3 id="1-12-创建ProcessDataHandler"><a href="#1-12-创建ProcessDataHandler" class="headerlink" title="1.12 创建ProcessDataHandler"></a>1.12 创建ProcessDataHandler</h3><p>ProcessDataHander用于在流程完结时处理流程数据，比如更新流程状态，发送通知等等操作都可以在这一步完成。</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pactera.cms.travel.handler;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.pactera.cms.travel.constant.TravelConstant;
<span class="hljs-keyword">import</span> com.pactera.cms.travel.constant.TravelExpenseStatus;
<span class="hljs-keyword">import</span> com.pactera.cms.travel.model.TravelExpense;
<span class="hljs-keyword">import</span> com.pactera.cms.travel.service.TravelExpenseService;
<span class="hljs-keyword">import</span> com.pactera.jep.core.holder.SpringContextHolder;
<span class="hljs-keyword">import</span> com.pactera.jep.workflow.api.WorkflowException;
<span class="hljs-keyword">import</span> com.pactera.jep.workflow.client.ProcessDataHandler;
<span class="hljs-keyword">import</span> com.pactera.jep.workflow.client.annotation.DataHandler;

<span class="hljs-comment">/**
 * 处理业务数据，流程完结时调用
 *
 * <span class="hljs-doctag">@Author</span>: 李涛
 * <span class="hljs-doctag">@CreateDate</span>: 2019/4/14 21:57
 * <span class="hljs-doctag">@Version</span>: 1.0
 */</span>
<span class="hljs-meta">@DataHandler</span>(TravelConstant.process_code)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TravelProcessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProcessDataHandler</span></span>&#123;

    <span class="hljs-comment">/**
     * 处理业务JSON格式的数据
     * 该方法应具备幂等性
     * 如无异常发生，代表数据处理成功
     *
     * <span class="hljs-doctag">@param</span> data
     * <span class="hljs-doctag">@throws</span> WorkflowException
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleData</span><span class="hljs-params">(String data)</span> <span class="hljs-keyword">throws</span> WorkflowException </span>&#123;
        <span class="hljs-comment">//转换对象</span>
        TravelExpense travelExpense = JSON.parseObject(data,TravelExpense.class);
        TravelExpenseService travelExpenseService = SpringContextHolder.getBean(TravelExpenseService.class);
        <span class="hljs-comment">//更新流程状态</span>
        travelExpense.setStatus(TravelExpenseStatus.APPROVED.getCode());
        travelExpenseService.update(travelExpense);
    &#125;
&#125;</code></pre>
<h3 id="1-13-测试流程"><a href="#1-13-测试流程" class="headerlink" title="1.13 测试流程"></a>1.13 测试流程</h3><p>经过上面的步骤，我们的流程编码环节完成了，让我们来测试流程吧！你需要把所有的服务都正确启动。</p>
<ul>
<li>ijep-service-sys</li>
<li>ijep-registry-eureka</li>
<li>ijep-router-zuul</li>
<li>ijep-service-bpm</li>
<li>cms-service</li>
</ul>
<p>确保上面的服务都正确启动，并且链接到cms数据库。</p>
<h4 id="1-13-1-流程发起测试"><a href="#1-13-1-流程发起测试" class="headerlink" title="1.13.1 流程发起测试"></a>1.13.1 流程发起测试</h4><p>通过POSTMAN调用业务接口即可。这里不需要前端页面进行测试。</p>
<p><img src=".\workflow-image\发起流程测试.png" alt="1555252102807"></p>
<h4 id="1-13-2-流程审批测试"><a href="#1-13-2-流程审批测试" class="headerlink" title="1.13.2 流程审批测试"></a>1.13.2 流程审批测试</h4><p>流程审批测试的时候建议通过浏览器发起处理审批动作，这里需要你本地启动前端。</p>
<p>用赋予角色的用户登录，点击菜单 我的工作台-我的审批-待审批，然后找到对应流程点击处理即可。</p>
<p><img src=".\workflow-image\审批流程.png" alt="1555251831956"></p>
<h2 id="2-流程引擎"><a href="#2-流程引擎" class="headerlink" title="2 流程引擎"></a>2 流程引擎</h2><h3 id="2-1-什么工作流？"><a href="#2-1-什么工作流？" class="headerlink" title="2.1 什么工作流？"></a>2.1 什么工作流？</h3><p>什么是工作流？在我们平时的工作中有许多涉及许多流程，比如员工请假需要直线经理审批，这个流程由请假人发起，请假人填写请假理由，然后给经理审批。经理同意，那么你请假就成功了；经理不同意，那么你这次请假就黄了，老老实实加班吧！这就是一个比较简单的涉及到两个节点工作流（workflow）。那么我们怎么表示这个流程呢？我们可以简单的画出这个请假的流程图。</p>
<p><img src="./workflow-image/请假申请流程.png" alt="请假申请流程图"></p>
<p>我们把员工抽象成一个<code>SUBMIT</code>角色，经理抽象成<code>APPROVE</code>角色，甚至这两个节点上的角色可以任意变化，那么这个这个流程可以画成这样：</p>
<p><img src="./workflow-image/提交审核流程.png" alt="提交审核流程"></p>
<p>提交、审批，只要是只有两个节点的流程都可以用这个流程图来概括，对于不同的业务流程，只是节点对应的角色不一样，这样我们就得到了一个<strong>流程模版</strong>。流程模版定义了一个流程的基础内容，我们可以在实现真正业务流程的时候，定制这个流程模板的内容，就可以实现一个真正的业务流程了。</p>
<p>通常在业务处理的过程中，往往需要许多岗位的配合才能完成一项工作，或者需要多个步骤才能完成一项工作，如果直接使用代码来实现，会相当复杂，因为流程涉及到提交、审核、退回、签领、加签、跳转、待办等等复杂的流转过程。<strong>工作流引擎</strong>可以帮我们把流程中涉及到的各个环节、步骤都管理起来，把每个节点涉及到的人员、服务、任务都串织起来，这样我们在业务开发中不需要关心流程怎么流转，把复杂的流转过程交给流程引擎控制，而我们只需要完成对应节点的业务功能即可。</p>
<p>我们来看一个稍微复杂的流程。公司规定出差打车可以报销，报销金额在0-100，只需要经理审批；100-200，需要公司副总审批；200以上需要总经理审批。那么这个流程又该怎么实现呢？</p>
<p><img src="./workflow-image/%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%B5%81%E7%A8%8B.png" alt="条件流程"></p>
<p>原来我们可以把<strong>判断条件</strong>放到连线上，当提交的表单中的参数，满足连线上的条件时，流程就可以按照我们设定的规则流转下去。这样，流程就有了分支，我们还可以定义其他的内容，后面我们再详细的说明。通常银行的业务远比这个流程复杂，但是万变不离其宗，你理解了工作流的本质，这些也好理解了。</p>
<h3 id="2-2-常见流程引擎"><a href="#2-2-常见流程引擎" class="headerlink" title="2.2 常见流程引擎"></a>2.2 常见流程引擎</h3><p>在Java的世界里面，开源的工作流引擎有许多，其中最出名的当然是Activiti了。我们的工作流引擎也是基于Activiti定制的，扩展了许多内容。下面我简单说说现在流行的工作流引擎。</p>
<h4 id="2-2-1-Activiti"><a href="#2-2-1-Activiti" class="headerlink" title="2.2.1 Activiti"></a>2.2.1 Activiti</h4><p>Activiti传承自上古流程引擎框架jbpm。jbpm是JBoss容器下的产品，是一个业务流程管理(BPM)和工作流系统，适用于开发人员和系统管理员。其核心是超快速，稳定的BPMN2流程引擎 。Activiti的作者是JBPM的作者，也是基于BPMN2 规范的开源流程引擎。现在Github上Start 4940. <code>https://github.com/Activiti/Activiti</code></p>
<h4 id="2-2-2-OpenWebFlow"><a href="#2-2-2-OpenWebFlow" class="headerlink" title="2.2.2 OpenWebFlow"></a>2.2.2 OpenWebFlow</h4><p>openwebflow是国人基于Activiti二次开发的工作流引擎。它对Activiti的工作流引擎扩展，接管了Activiti对活动权限以及用户表的管理，并提供了催办、代办、加签（包括前加签/后加签）、自由跳转、分裂节点等功能 。现在Github上Start 586. <code>https://github.com/bluejoe2008/openwebflow</code></p>
<h4 id="2-2-3-Flowable"><a href="#2-2-3-Flowable" class="headerlink" title="2.2.3 Flowable"></a>2.2.3 Flowable</h4><p>flowable工作流是Activiti团队一个分支，从JBPM到Activiti到flowableflowable是一个用Java实现的轻量级业务工作流引擎，兼容activiti支持Spring 、Spring Boot可以部署到任意Java环境，如java SE、servlet容器、如Tomcat或jetty、Java EE 服务器 如JBoss容器等 .现在Github Start 1621. <code>https://github.com/flowable/flowable-engine</code></p>
<p>还有些其他的工作流引擎，因为或多或少都是受到了JBPM的影响，就不再列举了。有兴趣的可以在Google上搜索一番。</p>
<h3 id="2-3-BPMN2-0-规范"><a href="#2-3-BPMN2-0-规范" class="headerlink" title="2.3 BPMN2.0 规范"></a>2.3 BPMN2.0 规范</h3><p>BPMN规范是由标准组织BPMI发布的.BPMN 1.0规范发布于2004年5月。此规范展示了BPMI组织两年多的努力成果。BPMN的主要目标就是要提供被所有业务用户理解的一套<a href="https://baike.baidu.com/item/%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80" target="_blank" rel="noopener">标记语言</a>，包括业务分析者、软件开发者以及业务管理者与监察者。BPMN还将支持生成可执行的BPEL4WS语言。所以，BPMN在业务流程设计与流程实现之间搭建了一条标准化的桥梁。</p>
<p>BPMN定义了业务流程图，其基于流程图技术，同时为创建业务流程操作的图形化模型进行了裁减。业务流程的模型就是图形化对象的网图，包括活动（也可以说工作）和定义操作顺序的流控制。你必须遵守BPMN2.0的规范来绘制流程图，这样不同的流程引擎都可以解析你的流程图，同时大家也知道你流程图想要表达的意思。</p>
<p>说了那么多，其实也就是说BPMN2.0规范是指导你绘制流程图的，有道是：道路千万条，规范第一条，画图不规范，开发两行泪！</p>
<p>BPMN参考：</p>
<ul>
<li>[1] <em><a href="https://docs.awspaas.com/reference-guide/aws-paas-process-reference-guide/process_structure/events.html" target="_blank" rel="noopener">https://docs.awspaas.com/reference-guide/aws-paas-process-reference-guide/process_structure/events.html</a></em></li>
<li>[2] <em><a href="https://www.omg.org/spec/BPMN/2.0/" target="_blank" rel="noopener">https://www.omg.org/spec/BPMN/2.0/</a></em></li>
</ul>
<h2 id="3-ijep流程引擎"><a href="#3-ijep流程引擎" class="headerlink" title="3 ijep流程引擎"></a>3 ijep流程引擎</h2><p>ijep工作流引擎是基于Activiti的分布式的工作流引擎，包含了流程模版管理、流程表单管理、业务流程配置、流程监控、我的流程等模块，细分下来有几十个功能，满足银行、证券等行业的复杂业务流程需求。下面简单介绍包含的业务功能。</p>
<p><img src=".\workflow-image\流程菜单.png" alt="1554997571028"></p>
<h3 id="3-1-流程模板管理"><a href="#3-1-流程模板管理" class="headerlink" title="3.1  流程模板管理"></a>3.1  流程模板管理</h3><p>流程模版管理主要是部署流程模板，支持在线编辑模板，也支持从其他地方导入流程模板。只要是符合BPMN2.0规范的流程图文件都是支持的。流程编码是唯一的，<strong>本地上传时流程编码和流程文件名称要一致</strong>。</p>
<p><img src=".\workflow-image\流程模板管理-列表.png" alt="1554997627379"></p>
<p>流程模板编辑支持在线设计，可以方便的编辑流程模板。流模板编辑功能需要你对BPMN2.0规范有一定了解才能很好的绘制流程图，请参考<a href="www.baidu.com">工作流引擎介绍文档</a>。</p>
<p><img src=".\workflow-image\流程在线编辑.png" alt="1554997762341"></p>
<h3 id="3-2-流程表单管理"><a href="#3-2-流程表单管理" class="headerlink" title="3.2 流程表单管理"></a>3.2 流程表单管理</h3><p>流程表单管理，这里是管理流程使用的业务表单，其实是为了将流程引擎和业务表单关联起来。每一个流程都对应到一个申请表单，这里将你的业务表单进来即可。</p>
<p><img src=".\workflow-image\流程表单管理.png" alt="1554998060406"></p>
<h3 id="3-3-业务流程管理"><a href="#3-3-业务流程管理" class="headerlink" title="3.3 业务流程管理"></a>3.3 业务流程管理</h3><p>业务流程管理实际上是把流程模板实例化的过程。流程模板本身是业务无关的，通过业务流程管理功能，可以将流程模板和流程表单关联上，并且可以配置每个流程节点上的属性（候选人），流程连线上的条件。</p>
<p><img src=".\workflow-image\业务流程列表.png" alt="1554998244324"></p>
<p>业务流程设计主要是对流程节点进行配置，该节点的候选人是如何产生的，比如是通过角色、指定固定的人、通过规则引擎计算出来等等方式。另外将来还会拓展其他的功能。功能配置好以后，启用该业务流程即可。</p>
<p><img src=".\workflow-image\业务流程设计.png" alt="1554998302817"></p>
<h3 id="3-4-流程监控"><a href="#3-4-流程监控" class="headerlink" title="3.4 流程监控"></a>3.4 流程监控</h3><p>流程监控，实际上就是管理员可以手动调整流程，设置下一步审批人，下一个跳转的节点，让任意一个人参与到流程的审批中来。该功能是开放给管理员的。 下面简单介绍下功能</p>
<p>前加签：在当前审批人员审批前增加一个人来审批，原流程上没有这个人（节点）。</p>
<p>后加签：在当前审批人员审批后增加一个人来审批，原流程上没有这个人（节点）。</p>
<p><img src=".\workflow-image\流程业务功能.png" alt="1555131547807"></p>

  
  
  <div class="footer">
    发现错误？想参与编辑？
    <!-- <a href="https://github.com/vuejs/cn.vuejs.org/blob/master/src/v2/workflow/index.md" target="_blank"> -->
    <a href="#">
      在 GitHub 上编辑此页！
    </a>
  </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <!-- search -->
    <link href="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/search.css">
    <script src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script>
    [
      '#search-query-nav',
      '#search-query-sidebar',
      '#search-query-menu'
    ].forEach(function (selector) {
      if (!document.querySelector(selector)) return
      // search index defaults to v2
      var match = window.location.pathname.match(/^\/(v\d+)/)
      var version = match ? match[1] : 'v2'
      docsearch({
      appId: 'BH4D9OD16A',
      apiKey: '5638280abff9d207417bb03be05f0b25',
      indexName: 'vuejs_cn2',
      inputSelector: selector,
      algoliaOptions: { facetFilters: ["version:" + version] }
      })
    })
    </script>

    <!-- fastclick -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
    </script>
  </body>
</html>
